ind_access <- list_variables$ind_access
occupation <- list_variables$occupation
hazards <- list_variables$hazards
displaced <- list_variables$displaced
teacher <- list_variables$teacher
education_level_grade <- list_variables$education_level_grade
barrier = list_variables$barrier
number_displayed_barrier <- 5
# non formal
nonformal <-list_variables$nonformal
nonformal_type<-list_variables$nonformal_type
#wgs
wsg_seeing<-list_variables$wsg_seeing
wsg_hearing<-list_variables$wsg_hearing
wsg_walking<-list_variables$wsg_walking
wsg_remembering<-list_variables$wsg_remembering
wsg_selfcare<-list_variables$wsg_selfcare
wsg_communicating<-list_variables$wsg_communicating
no_difficulty <-list_variables$no_difficulty
some_difficulty <-list_variables$some_difficulty
lot_of_difficulty <-list_variables$lot_of_difficulty
cannot_do <-list_variables$cannot_do
label_overall <- if (language_assessment == "French") "Ensemble" else "Overall"
label_female <- if (language_assessment == "French") "Filles" else "Girls"
label_male <- if (language_assessment == "French") "Garcons" else "Boys"
label_edu_school_cycle <- if (language_assessment == "French") "Cycle Scolaire Assigné par Âge" else "Age-Assigned School Cycle"
# Read ISCED info
country_code <- str_sub(country_assessment, 1, 3)
info_country_school_structure <- read_ISCED_info(country_code, path_ISCED_file)
summary_info_school <- info_country_school_structure$summary_info_school
labels_with_ages <- summary_info_school %>%
rowwise() %>%
mutate(label = extract_label_for_level_ordering(summary_info_school, cur_data(), language_assessment)) %>%
pull(label)
# Read the loa
loa <- readxl::read_excel(loa_path, sheet = "Sheet1")
# Read data helper and process it
data_helper_sheets <- readxl::excel_sheets(data_helper_table)
data_helper <- data_helper_sheets %>%
map(~ read_excel(data_helper_table, sheet = .x)) |>
set_names(data_helper_sheets)
data_helper <- data_helper |>
map(~ .x |>
as.list() %>%
map(na.omit) %>%
map(c))
##################################################################################################
# 1 ----------------- 01-add_education_indicators.R -----------------
main_sheet <- label_main_sheet
loop_sheet <- label_edu_sheet
source('src/01-add_education_indicators.R') ## OUTPUT: output/loop_edu_recorded.xlsx
source('src/01-5-creating_loa.R')
# 2 ----------------- 02-education_analysis.R -----------------
source('src/02-education_analysis.R') ## OUTPUT: output/grouped_other_education_results_loop.RDS
View(grouped_other_education_results_loop)
# Load packages -----------------------------------------------------------
library(impactR.utils)
library(humind)
library(presentresults)
library(analysistools)
# Needed tidyverse packages
library(dplyr)
library(readxl)
library(openxlsx)
library(tidyr)
library(stringr)
library(ggplot2)
library(srvyr)
library(gt)
source("src/functions/00_edu_helper.R")
source("src/functions/00_edu_function.R")
source("src/functions/create_education_table_group_x_var.R")
source("src/functions/create_education_xlsx_table.R")
source("src/functions/helpers_x-crisis.R")
## --------------------------
country_assessment = 'SYR'
strata_var_names <- c("admin1", "admin2", "admin3", "stratum", "additional_stratum",
"add_col1", "add_col2", "add_col3", "add_col4",
"add_col5", "add_col6", "add_col7", "add_col8")
##---------------- READING INFO AND VARIABLES FROM  matadata.xlsx
source("src/00-getting-info-country.R")
language_assessment = list_info_general$language_assessment
## --------------- File paths
#-- input data
path_ISCED_file <- 'resources/UNESCO ISCED Mappings_MSNAcountries_consolidated.xlsx'
data_file <- paste0('../DATA/',country_assessment, '/',list_info_general$dataset)
label_main_sheet <- list_info_general$label_main_sheet
label_edu_sheet  <- list_info_general$label_edu_sheet
kobo_path <- paste0('../DATA/',country_assessment, '/',list_info_general$dataset)
label_survey_sheet  <-  list_info_general$label_survey_sheet
label_choices_sheet <-  list_info_general$label_choices_sheet
kobo_language_label <-  list_info_general$kobo_language_label
#-- input tool
# please modify the group_var according to your context
#loa_path = paste0('input_tool/edu_analysistools_loa_',country_assessment,  '.xlsx')
loa_path = paste0('input_tool/edu_analysistools_loa_starting_kit.xlsx')
suffix <- ifelse(language_assessment == "French", "_FR", "_EN")
data_helper_table <- paste0("input_tool/edu_table_helper", suffix,'_', country_assessment,".xlsx")
labelling_tool_path <- "input_tool/edu_indicator_labelling.xlsx"
## -------------  definition of variable according to the analysis' context
id_col_loop = list_variables$id_col_loop
id_col_main = list_variables$id_col_main
survey_start_date = list_variables$survey_start_date
school_year_start_month = list_variables$school_year_start_month # start school year in country
ind_age = list_variables$ind_age # individual age variable
ind_gender = list_variables$ind_gender # individual gender variable
pnta = list_variables$pnta
dnk = list_variables$dnk
yes = list_variables$yes
no = list_variables$no
weight_col <- list_variables$weight_col
#------------- indicators
ind_access <- list_variables$ind_access
occupation <- list_variables$occupation
hazards <- list_variables$hazards
displaced <- list_variables$displaced
teacher <- list_variables$teacher
education_level_grade <- list_variables$education_level_grade
barrier = list_variables$barrier
number_displayed_barrier <- 5
# non formal
nonformal <-list_variables$nonformal
nonformal_type<-list_variables$nonformal_type
#wgs
wsg_seeing<-list_variables$wsg_seeing
wsg_hearing<-list_variables$wsg_hearing
wsg_walking<-list_variables$wsg_walking
wsg_remembering<-list_variables$wsg_remembering
wsg_selfcare<-list_variables$wsg_selfcare
wsg_communicating<-list_variables$wsg_communicating
no_difficulty <-list_variables$no_difficulty
some_difficulty <-list_variables$some_difficulty
lot_of_difficulty <-list_variables$lot_of_difficulty
cannot_do <-list_variables$cannot_do
label_overall <- if (language_assessment == "French") "Ensemble" else "Overall"
label_female <- if (language_assessment == "French") "Filles" else "Girls"
label_male <- if (language_assessment == "French") "Garcons" else "Boys"
label_edu_school_cycle <- if (language_assessment == "French") "Cycle Scolaire Assigné par Âge" else "Age-Assigned School Cycle"
# Read ISCED info
country_code <- str_sub(country_assessment, 1, 3)
info_country_school_structure <- read_ISCED_info(country_code, path_ISCED_file)
summary_info_school <- info_country_school_structure$summary_info_school
labels_with_ages <- summary_info_school %>%
rowwise() %>%
mutate(label = extract_label_for_level_ordering(summary_info_school, cur_data(), language_assessment)) %>%
pull(label)
# Read the loa
loa <- readxl::read_excel(loa_path, sheet = "Sheet1")
# Read data helper and process it
data_helper_sheets <- readxl::excel_sheets(data_helper_table)
data_helper <- data_helper_sheets %>%
map(~ read_excel(data_helper_table, sheet = .x)) |>
set_names(data_helper_sheets)
data_helper <- data_helper |>
map(~ .x |>
as.list() %>%
map(na.omit) %>%
map(c))
##################################################################################################
# 1 ----------------- 01-add_education_indicators.R -----------------
main_sheet <- label_main_sheet
loop_sheet <- label_edu_sheet
#--------------------------------------------------------------------------------------------------------
# Read in the main and loop datasets
main <- readxl::read_xlsx(data_file,
na = c("NA", "#N/A", "", " ", "N/A"),
sheet = main_sheet)
loop <- readxl::read_xlsx(data_file,
na = c("NA", "#N/A", "", " ", "N/A"),
sheet = loop_sheet)
#check if start is NULL
if (is.null(survey_start_date) || is.na(survey_start_date)) {
main$start <- as.POSIXct("2024-06-01 11:54:54.574")
survey_start_date = 'start'
}
if (country_assessment == "MOZ") {
main[[survey_start_date]] <- substr(main[[survey_start_date]], 1, 10)
replacement_date <- "2025-08-20"
# identify missing or invalid values
invalid <- is.na(main[[survey_start_date]]) |
main[[survey_start_date]] == "" |
is.na(as.Date(main[[survey_start_date]], format = "%Y-%m-%d"))
# fill them
main[[survey_start_date]][invalid] <- replacement_date
}
if (country_assessment == "ETH") {
main[[survey_start_date]] <- substr(main[[survey_start_date]], 1, 10)
replacement_date <- "2024-07-20"
# identify missing or invalid values
invalid <- is.na(main[[survey_start_date]]) |
main[[survey_start_date]] == "" |
is.na(as.Date(main[[survey_start_date]], format = "%Y-%m-%d"))
# fill them
main[[survey_start_date]][invalid] <- replacement_date
}
occupation_col <- if (!is.null(list_variables$occupation)) paste0(list_variables$occupation, "_d") else NULL
hazards_col <- paste0(list_variables$hazards, "_d")
displaced_col <- paste0(list_variables$displaced, "_d")
teacher_col <- paste0(list_variables$teacher, "_d")
loop <- loop %>%
mutate(!!ind_age := as.numeric(.data[[ind_age]]))
if (country_assessment == "MMR") {
columns_to_convert <- c(
"edu_access_only_formal",
"edu_access_only_nonformal",
"edu_access_formal_OR_structured_nonformal",
"edu_access_formal_AND_nonformal",
"edu_access_formal_OR_nonformal"
)
loop <- loop %>%
mutate(across(all_of(columns_to_convert), ~ as.numeric(.)))
}
#--------------------------------------------------------------------------------------------------------
# Apply transformations to loop dataset
loop <- loop |>
# Education from Humind
add_loop_edu_ind_age_corrected(main = main, id_col_loop = id_col_loop, id_col_main = id_col_main, survey_start_date = survey_start_date,
school_year_start_month = school_year_start_month, ind_age = ind_age, schooling_start_age = 5) |>
add_loop_edu_access_d(ind_access = ind_access,  pnta = pnta, dnk = dnk, yes= yes,no =no) |>
add_loop_edu_disrupted_d(attack  = occupation, hazards = hazards, displaced = displaced, teacher = teacher, levels = c(yes, no, dnk, pnta))
View(loop)
# Load packages -----------------------------------------------------------
library(impactR.utils)
library(humind)
library(presentresults)
library(analysistools)
# Needed tidyverse packages
library(dplyr)
library(readxl)
library(openxlsx)
library(tidyr)
library(stringr)
library(ggplot2)
library(srvyr)
library(gt)
source("src/functions/00_edu_helper.R")
source("src/functions/00_edu_function.R")
source("src/functions/create_education_table_group_x_var.R")
source("src/functions/create_education_xlsx_table.R")
source("src/functions/helpers_x-crisis.R")
## --------------------------
country_assessment = 'SYR'
strata_var_names <- c("admin1", "admin2", "admin3", "stratum", "additional_stratum",
"add_col1", "add_col2", "add_col3", "add_col4",
"add_col5", "add_col6", "add_col7", "add_col8")
##---------------- READING INFO AND VARIABLES FROM  matadata.xlsx
source("src/00-getting-info-country.R")
language_assessment = list_info_general$language_assessment
## --------------- File paths
#-- input data
path_ISCED_file <- 'resources/UNESCO ISCED Mappings_MSNAcountries_consolidated.xlsx'
data_file <- paste0('../DATA/',country_assessment, '/',list_info_general$dataset)
label_main_sheet <- list_info_general$label_main_sheet
label_edu_sheet  <- list_info_general$label_edu_sheet
kobo_path <- paste0('../DATA/',country_assessment, '/',list_info_general$dataset)
label_survey_sheet  <-  list_info_general$label_survey_sheet
label_choices_sheet <-  list_info_general$label_choices_sheet
kobo_language_label <-  list_info_general$kobo_language_label
#-- input tool
# please modify the group_var according to your context
#loa_path = paste0('input_tool/edu_analysistools_loa_',country_assessment,  '.xlsx')
loa_path = paste0('input_tool/edu_analysistools_loa_starting_kit.xlsx')
suffix <- ifelse(language_assessment == "French", "_FR", "_EN")
data_helper_table <- paste0("input_tool/edu_table_helper", suffix,'_', country_assessment,".xlsx")
labelling_tool_path <- "input_tool/edu_indicator_labelling.xlsx"
## -------------  definition of variable according to the analysis' context
id_col_loop = list_variables$id_col_loop
id_col_main = list_variables$id_col_main
survey_start_date = list_variables$survey_start_date
school_year_start_month = list_variables$school_year_start_month # start school year in country
ind_age = list_variables$ind_age # individual age variable
ind_gender = list_variables$ind_gender # individual gender variable
pnta = list_variables$pnta
dnk = list_variables$dnk
yes = list_variables$yes
no = list_variables$no
weight_col <- list_variables$weight_col
#------------- indicators
ind_access <- list_variables$ind_access
occupation <- list_variables$occupation
hazards <- list_variables$hazards
displaced <- list_variables$displaced
teacher <- list_variables$teacher
education_level_grade <- list_variables$education_level_grade
barrier = list_variables$barrier
number_displayed_barrier <- 5
# non formal
nonformal <-list_variables$nonformal
nonformal_type<-list_variables$nonformal_type
#wgs
wsg_seeing<-list_variables$wsg_seeing
wsg_hearing<-list_variables$wsg_hearing
wsg_walking<-list_variables$wsg_walking
wsg_remembering<-list_variables$wsg_remembering
wsg_selfcare<-list_variables$wsg_selfcare
wsg_communicating<-list_variables$wsg_communicating
no_difficulty <-list_variables$no_difficulty
some_difficulty <-list_variables$some_difficulty
lot_of_difficulty <-list_variables$lot_of_difficulty
cannot_do <-list_variables$cannot_do
label_overall <- if (language_assessment == "French") "Ensemble" else "Overall"
label_female <- if (language_assessment == "French") "Filles" else "Girls"
label_male <- if (language_assessment == "French") "Garcons" else "Boys"
label_edu_school_cycle <- if (language_assessment == "French") "Cycle Scolaire Assigné par Âge" else "Age-Assigned School Cycle"
# Read ISCED info
country_code <- str_sub(country_assessment, 1, 3)
info_country_school_structure <- read_ISCED_info(country_code, path_ISCED_file)
summary_info_school <- info_country_school_structure$summary_info_school
labels_with_ages <- summary_info_school %>%
rowwise() %>%
mutate(label = extract_label_for_level_ordering(summary_info_school, cur_data(), language_assessment)) %>%
pull(label)
# Read the loa
loa <- readxl::read_excel(loa_path, sheet = "Sheet1")
# Read data helper and process it
data_helper_sheets <- readxl::excel_sheets(data_helper_table)
data_helper <- data_helper_sheets %>%
map(~ read_excel(data_helper_table, sheet = .x)) |>
set_names(data_helper_sheets)
data_helper <- data_helper |>
map(~ .x |>
as.list() %>%
map(na.omit) %>%
map(c))
##################################################################################################
# 1 ----------------- 01-add_education_indicators.R -----------------
main_sheet <- label_main_sheet
loop_sheet <- label_edu_sheet
#--------------------------------------------------------------------------------------------------------
# Read in the main and loop datasets
main <- readxl::read_xlsx(data_file,
na = c("NA", "#N/A", "", " ", "N/A"),
sheet = main_sheet)
loop <- readxl::read_xlsx(data_file,
na = c("NA", "#N/A", "", " ", "N/A"),
sheet = loop_sheet)
#survey_start_date = 'today'
#check if start is NULL
if (is.null(survey_start_date) || is.na(survey_start_date)) {
main$start <- as.POSIXct("2024-06-01 11:54:54.574")
survey_start_date = 'start'
}
if (country_assessment == "MOZ") {
main[[survey_start_date]] <- substr(main[[survey_start_date]], 1, 10)
replacement_date <- "2025-08-20"
# identify missing or invalid values
invalid <- is.na(main[[survey_start_date]]) |
main[[survey_start_date]] == "" |
is.na(as.Date(main[[survey_start_date]], format = "%Y-%m-%d"))
# fill them
main[[survey_start_date]][invalid] <- replacement_date
}
if (country_assessment == "ETH") {
main[[survey_start_date]] <- substr(main[[survey_start_date]], 1, 10)
replacement_date <- "2024-07-20"
# identify missing or invalid values
invalid <- is.na(main[[survey_start_date]]) |
main[[survey_start_date]] == "" |
is.na(as.Date(main[[survey_start_date]], format = "%Y-%m-%d"))
# fill them
main[[survey_start_date]][invalid] <- replacement_date
}
#main <- main %>%
#mutate(survey_start_date = as_date(ymd_hms(survey_start_date)))
occupation_col <- if (!is.null(list_variables$occupation)) paste0(list_variables$occupation, "_d") else NULL
hazards_col <- paste0(list_variables$hazards, "_d")
displaced_col <- paste0(list_variables$displaced, "_d")
teacher_col <- paste0(list_variables$teacher, "_d")
loop <- loop %>%
mutate(!!ind_age := as.numeric(.data[[ind_age]]))
if (country_assessment == "MMR") {
columns_to_convert <- c(
"edu_access_only_formal",
"edu_access_only_nonformal",
"edu_access_formal_OR_structured_nonformal",
"edu_access_formal_AND_nonformal",
"edu_access_formal_OR_nonformal"
)
loop <- loop %>%
mutate(across(all_of(columns_to_convert), ~ as.numeric(.)))
}
#--------------------------------------------------------------------------------------------------------
# Apply transformations to loop dataset
loop <- loop |>
# Education from Humind
add_loop_edu_ind_age_corrected(main = main, id_col_loop = id_col_loop, id_col_main = id_col_main, survey_start_date = survey_start_date,
school_year_start_month = school_year_start_month, ind_age = ind_age, schooling_start_age = 5) |>
add_loop_edu_access_d(ind_access = ind_access,  pnta = pnta, dnk = dnk, yes= yes,no =no) |>
add_loop_edu_disrupted_d(attack  = occupation, hazards = hazards, displaced = displaced, teacher = teacher, levels = c(yes, no, dnk, pnta))
loop <- loop %>%
dplyr::rename(
edu_disrupted_hazards_d = !!rlang::sym(hazards_col),
edu_disrupted_displaced_d = !!rlang::sym(displaced_col),
edu_disrupted_teacher_d = !!rlang::sym(teacher_col)
)
View(loop)
# Load packages -----------------------------------------------------------
library(impactR.utils)
library(humind)
library(presentresults)
library(analysistools)
# Needed tidyverse packages
library(dplyr)
library(readxl)
library(openxlsx)
library(tidyr)
library(stringr)
library(ggplot2)
library(srvyr)
library(gt)
source("src/functions/00_edu_helper.R")
source("src/functions/00_edu_function.R")
source("src/functions/create_education_table_group_x_var.R")
source("src/functions/create_education_xlsx_table.R")
source("src/functions/helpers_x-crisis.R")
## --------------------------
country_assessment = 'SYR'
strata_var_names <- c("admin1", "admin2", "admin3", "stratum", "additional_stratum",
"add_col1", "add_col2", "add_col3", "add_col4",
"add_col5", "add_col6", "add_col7", "add_col8")
##---------------- READING INFO AND VARIABLES FROM  matadata.xlsx
source("src/00-getting-info-country.R")
language_assessment = list_info_general$language_assessment
## --------------- File paths
#-- input data
path_ISCED_file <- 'resources/UNESCO ISCED Mappings_MSNAcountries_consolidated.xlsx'
data_file <- paste0('../DATA/',country_assessment, '/',list_info_general$dataset)
label_main_sheet <- list_info_general$label_main_sheet
label_edu_sheet  <- list_info_general$label_edu_sheet
kobo_path <- paste0('../DATA/',country_assessment, '/',list_info_general$dataset)
label_survey_sheet  <-  list_info_general$label_survey_sheet
label_choices_sheet <-  list_info_general$label_choices_sheet
kobo_language_label <-  list_info_general$kobo_language_label
#-- input tool
# please modify the group_var according to your context
#loa_path = paste0('input_tool/edu_analysistools_loa_',country_assessment,  '.xlsx')
loa_path = paste0('input_tool/edu_analysistools_loa_starting_kit.xlsx')
suffix <- ifelse(language_assessment == "French", "_FR", "_EN")
data_helper_table <- paste0("input_tool/edu_table_helper", suffix,'_', country_assessment,".xlsx")
labelling_tool_path <- "input_tool/edu_indicator_labelling.xlsx"
## -------------  definition of variable according to the analysis' context
id_col_loop = list_variables$id_col_loop
id_col_main = list_variables$id_col_main
survey_start_date = list_variables$survey_start_date
school_year_start_month = list_variables$school_year_start_month # start school year in country
ind_age = list_variables$ind_age # individual age variable
ind_gender = list_variables$ind_gender # individual gender variable
pnta = list_variables$pnta
dnk = list_variables$dnk
yes = list_variables$yes
no = list_variables$no
weight_col <- list_variables$weight_col
#------------- indicators
ind_access <- list_variables$ind_access
occupation <- list_variables$occupation
hazards <- list_variables$hazards
displaced <- list_variables$displaced
teacher <- list_variables$teacher
education_level_grade <- list_variables$education_level_grade
barrier = list_variables$barrier
number_displayed_barrier <- 5
# non formal
nonformal <-list_variables$nonformal
nonformal_type<-list_variables$nonformal_type
#wgs
wsg_seeing<-list_variables$wsg_seeing
wsg_hearing<-list_variables$wsg_hearing
wsg_walking<-list_variables$wsg_walking
wsg_remembering<-list_variables$wsg_remembering
wsg_selfcare<-list_variables$wsg_selfcare
wsg_communicating<-list_variables$wsg_communicating
no_difficulty <-list_variables$no_difficulty
some_difficulty <-list_variables$some_difficulty
lot_of_difficulty <-list_variables$lot_of_difficulty
cannot_do <-list_variables$cannot_do
label_overall <- if (language_assessment == "French") "Ensemble" else "Overall"
label_female <- if (language_assessment == "French") "Filles" else "Girls"
label_male <- if (language_assessment == "French") "Garcons" else "Boys"
label_edu_school_cycle <- if (language_assessment == "French") "Cycle Scolaire Assigné par Âge" else "Age-Assigned School Cycle"
# Read ISCED info
country_code <- str_sub(country_assessment, 1, 3)
info_country_school_structure <- read_ISCED_info(country_code, path_ISCED_file)
summary_info_school <- info_country_school_structure$summary_info_school
labels_with_ages <- summary_info_school %>%
rowwise() %>%
mutate(label = extract_label_for_level_ordering(summary_info_school, cur_data(), language_assessment)) %>%
pull(label)
# Read the loa
loa <- readxl::read_excel(loa_path, sheet = "Sheet1")
# Read data helper and process it
data_helper_sheets <- readxl::excel_sheets(data_helper_table)
data_helper <- data_helper_sheets %>%
map(~ read_excel(data_helper_table, sheet = .x)) |>
set_names(data_helper_sheets)
data_helper <- data_helper |>
map(~ .x |>
as.list() %>%
map(na.omit) %>%
map(c))
##################################################################################################
# 1 ----------------- 01-add_education_indicators.R -----------------
main_sheet <- label_main_sheet
loop_sheet <- label_edu_sheet
#--------------------------------------------------------------------------------------------------------
# Read in the main and loop datasets
main <- readxl::read_xlsx(data_file,
na = c("NA", "#N/A", "", " ", "N/A"),
sheet = main_sheet)
loop <- readxl::read_xlsx(data_file,
na = c("NA", "#N/A", "", " ", "N/A"),
sheet = loop_sheet)
View(loop)
